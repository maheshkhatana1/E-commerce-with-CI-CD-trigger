pipeline {
    agent any

    environment {
        AWS_REGION = "ap-south-1"
        ECR_REPO   = "ecommerce-app"
        IMAGE_TAG  = "${BUILD_NUMBER}"

        // üîí SAFETY SWITCH
        DEPLOY = "false"   // change to "true" only when ready
    }

    stages {

        stage("Checkout Code") {
            steps {
                checkout scm
            }
        }

        stage("Terraform Format & Validate") {
            steps {
                dir('terraform') {
                    sh '''
                    terraform fmt -recursive
                    terraform init -backend=false
                    terraform validate
                    '''
                }
            }
        }

        stage("Checkov - Terraform Security Scan") {
            steps {
                sh 'checkov -d terraform/ --severity HIGH,CRITICAL'
            }
        }

        stage("Terraform Plan") {
            steps {
                dir('terraform') {
                    sh '''
                    terraform init
                    terraform plan -out=tfplan
                    '''
                }
            }
        }

        stage("Manual Approval") {
            when {
                expression { env.DEPLOY == "true" }
            }
            steps {
                input message: "üö® Approve Terraform APPLY & Deployment?"
            }
        }

        stage("Terraform Apply") {
            when {
                expression { env.DEPLOY == "true" }
            }
            steps {
                dir('terraform') {
                    sh 'terraform apply -auto-approve tfplan'
                }
            }
        }

        stage("Build Docker Image") {
            steps {
                sh '''
                docker build -t ${ECR_REPO}:${IMAGE_TAG} -f docker/Dockerfile .
                '''
            }
        }

        stage("Trivy - Docker Image Scan") {
            steps {
                sh '''
                trivy image --severity HIGH,CRITICAL ${ECR_REPO}:${IMAGE_TAG}
                '''
            }
        }

        stage("Authenticate to AWS ECR") {
            when {
                expression { env.DEPLOY == "true" }
            }
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                  credentialsId: 'aws-creds']]) {
                    sh '''
                    aws ecr get-login-password --region ${AWS_REGION} \
                    | docker login --username AWS --password-stdin \
                    $(aws ecr describe-repositories \
                    --repository-names ${ECR_REPO} \
                    --query 'repositories[0].repositoryUri' \
                    --output text)
                    '''
                }
            }
        }

        stage("Push Image to ECR") {
            when {
                expression { env.DEPLOY == "true" }
            }
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                                  credentialsId: 'aws-creds']]) {
                    sh '''
                    ECR_URI=$(aws ecr describe-repositories \
                    --repository-names ${ECR_REPO} \
                    --query 'repositories[0].repositoryUri' \
                    --output text)

                    docker tag ${ECR_REPO}:${IMAGE_TAG} ${ECR_URI}:${IMAGE_TAG}
                    docker push ${ECR_URI}:${IMAGE_TAG}
                    '''
                }
            }
        }

        stage("Dry Run Summary") {
            when {
                expression { env.DEPLOY == "false" }
            }
            steps {
                echo '''
                ‚úÖ DRY RUN COMPLETED
                - Terraform validated & planned
                - Security scans completed
                - Docker image built
                - NO AWS resources created
                '''
            }
        }
    }

    post {
        success {
            echo "üéâ Pipeline completed successfully"
        }
        failure {
            echo "‚ùå Pipeline failed"
        }
    }
}
